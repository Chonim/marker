!function(e){"use strict";var t="ø^˚",o="marker",n="marker-active",r="data-unique-name",a="data-order";e.widget("ds.marker",{options:{minimum:3,maximum:3e3,overlap:!1,colorPicker:!0,style:{background:"rgba(249, 255, 0, 0.2)"},activeRemove:!0,caseSensitive:!0,add:void 0,remove:void 0,colorChange:void 0,mouseenter:void 0,mouseleave:void 0,debug:void 0},_create:function(){var i=this,c=!1,s=function(n){c=!1,n.preventDefault();var s=this,l=n.target,d=n.which;if(1===d){n.preventDefault();var u,m,p,g="";if(window.getSelection){if(u=window.getSelection(),u.rangeCount?m=u.getRangeAt(0):(m=document.createRange(),m.collapse(!0)),!i._validatemarker(m)[0])return void i._callback("debug",n,i._validatemarker(m)[1]);p=document.createRange(),p.selectNodeContents(s),p.setEnd(m.startContainer,m.startOffset);var v=m.cloneRange(),f=document.createElement("div");f.innerHTML=t;for(var h,k,_=document.createDocumentFragment();h=f.firstChild;)k=_.appendChild(h);m.insertNode(_),g=p.toString(),p.selectNodeContents(s),p.setStart(m.endContainer,m.endOffset),p.insertNode(document.createTextNode(t)),p.detach()}else if(document.selection&&"Control"!=document.selection.type){if(m=u.createRange(),!i._validatemarker(m)[0])return void i._callback("debug",n,i._validatemarker(m)[1]);p=document.body.createTextRange(),p.moveToElementText(s),p.setEndPoint("EndToStart",m),v=m.duplicate(),m.pasteHTML(t),v.setEndPoint("EndToEnd",m),g=p.text,p.moveToElementText(s),p.setEndPoint("StartToEnd",m)}var b=e(s).html().toString().split(t),w=b[1],C=/(<[^>]*>)/g,y=w.split(C),S="",x=i._generateUnqName();e.each(y,function(t,n){if(C.test(n))S+=n;else if(g+=n,n.trim().length>0){var c=e("<span/>");c.addClass(o),c.attr(r,x),c.attr(a,i._getTextOccur(g,n)),e.each(i.options.style,function(e,t){c.css(e,t)}),c.append(n),S+=c[0].outerHTML}else S+=n}),b[1]=S,e(s).html(b.join("")),i._deselection(),i._callback("add",n)}else if(3===d&&(n.preventDefault(),e(l).hasClass(o)&&i.options.activeRemove)){var x=e(l).attr(r),T=e(s).find("."+o+"["+r+'="'+x+'"]');i.clear(T)}},l=function(t){if(i._callback("mouseenter",t),1!=c){e("."+n).removeClass(n);var a=e(t.target).attr(r);if(e("."+o+"["+r+'="'+a+'"]').addClass(n),e(t.target).hasClass(o)&&e(t.relatedTarget).hasClass(o)&&e(t.target).attr(r)!=e(t.relatedTarget).attr(r)){e("."+n).removeClass(n);var s=e(t.target).attr(r);e("."+o+"["+r+'="'+s+'"]').addClass(n)}}},d=function(t){if(i._callback("mouseleave",t),e("."+n).removeClass(n),1!=c&&e(t.target).hasClass(o)&&e(t.relatedTarget).hasClass(o)&&e(t.target).attr(r)!=e(t.relatedTarget).attr(r)){e("."+n).removeClass(n);var a=e(t.relatedTarget).attr(r);e("."+o+"["+r+'="'+a+'"]').addClass(n)}},u=function(e){1==e.which&&(c=!0)},m=function(t){1==c&&e("#color-picker").length>0&&1==i.options.colorPicker&&(e("#color-picker").spectrum("disable"),e("#color-picker").spectrum("destroy"),e("#color-picker").remove())},p=function(e){e.preventDefault()},g=function(t){if(t.stopPropagation(),i._callback("click",t),1==i.options.colorPicker){var n=e(t.target).attr(r),a=e("."+o+"["+r+'="'+n+'"]'),c=e('<input type="text" id="color-picker" />');e("#color-picker").spectrum("disable"),e("#color-picker").spectrum("destroy"),e("#color-picker").remove(),e("body").append(c),e("#color-picker").spectrum({color:a.first().css("background-color"),flat:!0,showAlpha:!0,showButtons:!1,change:function(o){a.css("background-color","rgba("+Math.round(o._r)+", "+Math.round(o._g)+", "+Math.round(o._b)+", "+o._a+")"),e("#color-picker").spectrum("disable"),e("#color-picker").spectrum("destroy"),e("#color-picker").remove(),i._callback("colorChange",t)},move:function(e){a.css("background-color","rgba("+Math.round(e._r)+", "+Math.round(e._g)+", "+Math.round(e._b)+", "+e._a+")")}}),e("#color-picker").spectrum("container").css({position:"absolute",top:t.pageY,left:t.pageX})}};return i.element.on("contextmenu",p),i.element.on("mousedown",u),i.element.on("mouseup",s),i.element.on("mouseenter","."+o,l),i.element.on("mouseleave","."+o,d),i.element.on("click","."+o,g),i.element.on("mousemove",m),i},_destroy:function(){var e=this;e.clear(),e.element.off()},_callback:function(e,t,o){var n=this;n._trigger(e,t,[o])},restore:function(n){function i(e,t,o){return e.split(t,o).join(t).length}function c(e,t,n){var i=t.text.length;return e.slice(0,n)+'<span class="'+o+'" '+r+'="'+t.uniqueName+'" '+a+'="'+t.order+'" style="'+t.style+'" >'+e.slice(n,n+i)+"</span>"+e.slice(n+i)}var s=this;s.clear();var l=/(<[^>]*>)/g,d=s.element.html().split(l),u=[];e.each(d,function(e,o){l.test(o)&&(u.push(o),d[e]=t)});var m=d.join("");e.each(n,function(e,t){var o;o=s.options.caseSensitive?i(m,t.text,t.order):i(m.toLowerCase(),t.text.toLowerCase(),t.order),m=c(m,t,o)});for(var p=0;p<u.length;p++)m=m.replace(t,u[p]);s.element.html(m)},data:function(t){var n=this,i=n.element.find("."+o),c=[];e.each(i,function(t,o){var n={style:e(o).attr("style"),order:e(o).attr(a),uniqueName:e(o).attr(r),text:e(o).text()};c.push(n)}),n._callback("data",t,c)},clear:function(t,n){var r=this,a=t;a||(a=r.element.find("."+o)),e.each(a,function(t,o){e(o).off(),e(o).contents().unwrap()}),1==r.options.colorPicker&&(e("#color-picker").spectrum("disable"),e("#color-picker").spectrum("destroy"),e("#color-picker").remove()),r._callback("remove",n)},_generateUnqName:function(){function e(){return Math.random().toString(16).slice(-4)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},_validatemarker:function(t,n){var r,a=this,i=!0;return i&&0==t.toString().length&&(a._deselection(),i=!1),i&&t.toString().length<a.options.minimum&&(a._deselection(),a.options.debug&&(r="Block setting can be at least "+a.options.minimum+' characters.\nSet the "minimum" option to a smaller size if you want to set marker.'),i=!1),i&&t.toString().length>a.options.maximum&&(a._deselection(),a.options.debug&&(r="Block settings can be up to "+a.options.maximum+' characters.\nSet the "maximum" option to a larger size if you want to set marker.'),i=!1),i&&a._getParentNode(t).className.indexOf(o)>-1&&0==a.options.overlap&&(a._deselection(),a.options.debug&&(r='Set the "overlap" option to "true" if you want to set overap marker.'),i=!1),i&&e(t.cloneContents()).children().find("*").filter("."+o).length+e(t.cloneContents()).children().find("*").prevObject.filter("."+o).length>0&&0==a.options.overlap&&(a._deselection(),a.options.debug&&(r='Set the "overlap" option to "true" if you want to set overap marker.'),i=!1),[i,r]},_getTextOccur:function(e,t){for(var o=0,n=0,r=this;;){if(n=r.options.caseSensitive?e.indexOf(t,n):e.toLowerCase().indexOf(t.toLowerCase(),n),-1==n)break;o++,n+=t.length}return o},_deselection:function(){window.getSelection?window.getSelection().empty?window.getSelection().empty():window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges():document.selection&&document.selection.empty()},_getParentNode:function(e){var t;for(window.getSelection?t=e.commonAncestorContainer:document.selection&&"Control"!=document.selection.type&&(t=e.parentElement());t;){if(1==t.nodeType&&"undefined"!=t.tagName)return t;t=t.parentNode}}})}(jQuery),$(window).scroll(function(){$("#color-picker").spectrum("disable"),$("#color-picker").spectrum("destroy"),$("#color-picker").remove()});
